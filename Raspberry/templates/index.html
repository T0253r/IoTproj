<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Ogrzewania</title>
    <link rel="stylesheet" href="{{ url_for(endpoint='.static', filename='style.css') }}">
</head>

<body>

    <nav>
        <p class="app-title"><span class="mdi--hot-cold"></span>System Ogrzewania</p>
        {% if user_username %}
        <p>Witaj {{ user_username }}</p>
        {% endif %}
        <a class="mdi--gear" href="/settings"></a>
    </nav>

    <!-- Horizontally scrollable controller cards -->
    <div class="controller-row">
        {% for c in controllers %}
        <div class="controller-card {% if c['target_temp'] > c['curr_temp'] %} heating {% elif c['target_temp'] <
            c['curr_temp'] %} cooling {% else %} stable {% endif %}"
            onclick="selectController('{{ c['controller_id'] }}')" id="card-{{ c['controller_id'] }}">

            <span class="controller-name">{{ c['name'] }}</span>
            <!-- <div>Current: <strong>{{ c['curr_temp'] }}°C</strong></div>
            <div>Target: <strong class="target-temp-accent">{{ c['target_temp'] }}°C</strong></div> -->
            <div class="controller-card-temp">
                <div>
                    <strong>{{ c['curr_temp'] }}°C</strong>
                    <span>Obecna</span>
                </div>
                <div>
                    <strong>{{ c['target_temp'] }}°C</strong>
                    <span>Docelowa</span>
                </div>
            </div>
            <div class="info-small">
                {% if c['priority'] == 2 %}
                <span class="status-locked">Ręczna zmiana</span>
                {% elif c['priority'] == 1 %}
                <span class="status-auto">AutoTemp</span>
                {% else %}
                <span class="status-default">System</span>
                {% endif %}
            </div>

            <div class="card-vortex">
                <svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink"
                    xmlns:svgjs="http://svgjs.dev/svgjs" viewBox="0 0 800 800">
                    <defs>
                        <linearGradient x1="50%" y1="0%" x2="50%" y2="100%" id="vvvortex-grad-{{ c['controller_id'] }}">
                            <stop stop-opacity="1" offset="0%"></stop>
                            <stop stop-opacity="1" offset="100%"></stop>
                        </linearGradient>
                    </defs>
                    <g stroke="url(#vvvortex-grad-{{ c['controller_id'] }})" fill="none" stroke-linecap="round">
                        <circle r="363" cx="400" cy="400" stroke-width="11" stroke-dasharray="27 16"
                            stroke-dashoffset="25" transform="rotate(60, 400, 400)" opacity="0.05"></circle>
                        <circle r="346.5" cx="400" cy="400" stroke-width="11" stroke-dasharray="52 17"
                            stroke-dashoffset="25" transform="rotate(169, 400, 400)" opacity="0.10"></circle>
                        <circle r="330" cx="400" cy="400" stroke-width="10" stroke-dasharray="33 38"
                            stroke-dashoffset="25" transform="rotate(234, 400, 400)" opacity="0.14"></circle>
                        <circle r="313.5" cx="400" cy="400" stroke-width="10" stroke-dasharray="26 42"
                            stroke-dashoffset="25" transform="rotate(254, 400, 400)" opacity="0.19"></circle>
                        <circle r="297" cx="400" cy="400" stroke-width="10" stroke-dasharray="46 36"
                            stroke-dashoffset="25" transform="rotate(54, 400, 400)" opacity="0.23"></circle>
                        <circle r="280.5" cx="400" cy="400" stroke-width="10" stroke-dasharray="28 40"
                            stroke-dashoffset="25" transform="rotate(156, 400, 400)" opacity="0.28"></circle>
                        <circle r="264" cx="400" cy="400" stroke-width="9" stroke-dasharray="53 27"
                            stroke-dashoffset="25" transform="rotate(32, 400, 400)" opacity="0.32"></circle>
                        <circle r="247.5" cx="400" cy="400" stroke-width="9" stroke-dasharray="43 42"
                            stroke-dashoffset="25" transform="rotate(216, 400, 400)" opacity="0.37"></circle>
                        <circle r="231" cx="400" cy="400" stroke-width="9" stroke-dasharray="31 12"
                            stroke-dashoffset="25" transform="rotate(215, 400, 400)" opacity="0.41"></circle>
                        <circle r="214.5" cx="400" cy="400" stroke-width="8" stroke-dasharray="14 54"
                            stroke-dashoffset="25" transform="rotate(297, 400, 400)" opacity="0.46"></circle>
                        <circle r="198" cx="400" cy="400" stroke-width="8" stroke-dasharray="17 17"
                            stroke-dashoffset="25" transform="rotate(308, 400, 400)" opacity="0.50"></circle>
                        <circle r="181.5" cx="400" cy="400" stroke-width="8" stroke-dasharray="22 44"
                            stroke-dashoffset="25" transform="rotate(186, 400, 400)" opacity="0.55"></circle>
                        <circle r="165" cx="400" cy="400" stroke-width="8" stroke-dasharray="55 25"
                            stroke-dashoffset="25" transform="rotate(172, 400, 400)" opacity="0.59"></circle>
                        <circle r="148.5" cx="400" cy="400" stroke-width="7" stroke-dasharray="22 31"
                            stroke-dashoffset="25" transform="rotate(173, 400, 400)" opacity="0.64"></circle>
                        <circle r="132" cx="400" cy="400" stroke-width="7" stroke-dasharray="50 49"
                            stroke-dashoffset="25" transform="rotate(311, 400, 400)" opacity="0.68"></circle>
                        <circle r="115.5" cx="400" cy="400" stroke-width="7" stroke-dasharray="47 50"
                            stroke-dashoffset="25" transform="rotate(17, 400, 400)" opacity="0.73"></circle>
                        <circle r="99" cx="400" cy="400" stroke-width="6" stroke-dasharray="25 47"
                            stroke-dashoffset="25" transform="rotate(121, 400, 400)" opacity="0.77"></circle>
                        <circle r="82.5" cx="400" cy="400" stroke-width="6" stroke-dasharray="51 29"
                            stroke-dashoffset="25" transform="rotate(103, 400, 400)" opacity="0.82"></circle>
                        <circle r="66" cx="400" cy="400" stroke-width="6" stroke-dasharray="21 43"
                            stroke-dashoffset="25" transform="rotate(10, 400, 400)" opacity="0.86"></circle>
                        <circle r="49.5" cx="400" cy="400" stroke-width="6" stroke-dasharray="22 16"
                            stroke-dashoffset="25" transform="rotate(113, 400, 400)" opacity="0.91"></circle>
                        <circle r="33" cx="400" cy="400" stroke-width="5" stroke-dasharray="34 24"
                            stroke-dashoffset="25" transform="rotate(120, 400, 400)" opacity="0.95"></circle>
                        <circle r="16.5" cx="400" cy="400" stroke-width="5" stroke-dasharray="28 54"
                            stroke-dashoffset="25" transform="rotate(283, 400, 400)" opacity="1.00"></circle>
                    </g>
                </svg>
            </div>

        </div>
        {% endfor %}
    </div>

    <!-- Detailed view for each controller (hidden by default) -->
    <div class="controller-grid">
        {% for c in controllers %}
        <div class="controller-details" id="controller-{{ c['controller_id'] }}" style="display: none;">

            <h2>{{ c['name'] }}</h2>

            <!-- Temperature Display Grid -->
            <div class="temp-grid">
                <div class="temp-box">
                    <div class="temp-box-label">Aktualna temperatura</div>
                    <div class="temp-box-value" id="curr-temp-{{ c['controller_id'] }}">{{ c['curr_temp'] }}°C</div>
                </div>
                <div class="temp-box" style="position: relative;">
                    <div class="temp-box-label">Zadana temperatura</div>
                    <div class="temp-box-value" id="target-temp-{{ c['controller_id'] }}">{{ c['target_temp'] }}°C</div>
                    <div class="temp-controls"
                        style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%);">
                        <button class="temp-btn" onclick="adjustTemp('{{ c['controller_id'] }}', 0.5)" {{ 'disabled' if
                            not user_username }}>+</button>
                        <button class="temp-btn" onclick="adjustTemp('{{ c['controller_id'] }}', -0.5)" {{ 'disabled' if
                            not user_username }}>-</button>
                    </div>
                </div>
            </div>

            <!-- Status Line -->
            <div class="status-line">
                Status:
                {% if c['priority'] == 2 %}
                <span class="status-locked">Grzanie włączone (/ Temperatura osiągnięta / Grzanie wyłączone)</span>
                {% elif c['priority'] == 1 %}
                <span class="status-auto">AutoTemp - Voting</span>
                {% else %}
                <span class="status-default">System</span>
                {% endif %}
            </div>
            <div class="status-line">
                Ostatnia zmiana: {{ c['locked_by_name'] or 'N/A' }} ({{ c['last_seen'] or 'Never' }})
            </div>

            <!-- AutoTemp Section -->
            <div class="section-title">Twoje ustawienia AutoTemp™</div>
            <div class="info-small" style="margin-bottom: 1rem;">
                Automatyczna temperatura komfortowa po wykryciu obecności
            </div>

            <!-- Toggle Switch -->
            <div class="toggle-container">
                <label>Używaj AutoTemp™ w tym pokoju:</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="autotemp-{{ c['controller_id'] }}" {{ 'checked' if c['user_pref_temp'] }}
                        {{ 'disabled' if not user_username }}
                        onchange="toggleAutoTemp('{{ c['controller_id'] }}', this.checked, {{ c['user_pref_temp'] or 21.5 }})">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- Comfort Temperature Control -->
            <div class="comfort-temp-control">
                <div class="comfort-temp-label">Temperatura komfortowa</div>
                <div class="comfort-controls">
                    <button class="temp-btn" onclick="adjustPref('{{ c['controller_id'] }}', -0.5)" {{ 'disabled' if not
                        user_username }}>-</button>
                    <div class="comfort-temp-value" id="pref-temp-{{ c['controller_id'] }}">{{ c['user_pref_temp'] or
                        '21.5' }}°C</div>
                    <button class="temp-btn" onclick="adjustPref('{{ c['controller_id'] }}', 0.5)" {{ 'disabled' if not
                        user_username }}>+</button>
                </div>
            </div>

            {% if not user_username %}
            <div class="info-small warning-text" style="margin-top: 1rem;">
                Login required to change settings
            </div>
            {% endif %}

        </div>
        {% endfor %}
    </div>

    <script>
        let selectedControllerId = null;

        function selectController(controllerId) {
            selectedControllerId = controllerId;
            // Hide all controller details
            const details = document.querySelectorAll(".controller-grid .controller-details");
            details.forEach((detail) => (detail.style.display = "none"));

            // Remove active class from all cards
            const cards = document.querySelectorAll(".controller-card");
            cards.forEach((card) => card.classList.remove("active"));

            // Show selected controller details
            const selectedController = document.getElementById("controller-" + controllerId);
            if (selectedController) {
                selectedController.style.display = "block";
            }

            // Add active class to selected card
            const selectedCard = document.getElementById("card-" + controllerId);
            if (selectedCard) {
                selectedCard.classList.add("active");
            }
        }

        async function adjustTemp(controllerId, delta) {
            const targetElement = document.getElementById(`target-temp-${controllerId}`);
            const currentTemp = parseFloat(targetElement.textContent);
            const newTemp = currentTemp + delta;

            try {
                const response = await fetch('/set_manual_temp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        controller_id: controllerId,
                        target_temp: newTemp
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Update will happen on next refresh
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Error adjusting temperature:', error);
            }
        }

        async function adjustPref(controllerId, delta) {
            const prefElement = document.getElementById(`pref-temp-${controllerId}`);
            const currentPref = parseFloat(prefElement.textContent);
            const newPref = currentPref + delta;

            try {
                const response = await fetch('/set_preference', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        controller_id: controllerId,
                        pref_temp: newPref
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Update will happen on next refresh
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Error adjusting preference:', error);
            }
        }

        async function toggleAutoTemp(controllerId, isEnabled, currentTemp) {
            const endpoint = isEnabled ? '/set_preference' : '/clear_preference';
            const body = isEnabled
                ? { controller_id: controllerId, pref_temp: currentTemp }
                : { controller_id: controllerId };

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                const result = await response.json();
                if (!result.success) {
                    alert(result.message);
                    // Revert checkbox on error
                    const checkbox = document.getElementById(`autotemp-${controllerId}`);
                    if (checkbox) {
                        checkbox.checked = !isEnabled;
                    }
                }
            } catch (error) {
                console.error('Error toggling AutoTemp:', error);
            }
        }

        async function refreshControllers() {
            try {
                const response = await fetch('/refresh_controllers');
                const controllers = await response.json();

                controllers.forEach(c => {
                    // Update card styling
                    const card = document.getElementById(`card-${c.controller_id}`);
                    if (card) {
                        card.className = 'controller-card';
                        if (c.target_temp > c.curr_temp) {
                            card.classList.add('heating');
                        } else if (c.target_temp < c.curr_temp) {
                            card.classList.add('cooling');
                        } else {
                            card.classList.add('stable');
                        }
                        if (selectedControllerId == c.controller_id) {
                            card.classList.add('active');
                        }
                    }

                    // Update temperatures in cards
                    const cardTemps = card.querySelectorAll('.controller-card-temp strong');
                    if (cardTemps.length >= 2) {
                        cardTemps[0].textContent = `${c.curr_temp}°C`;
                        cardTemps[1].textContent = `${c.target_temp}°C`;
                    }

                    // Update status in card
                    const statusSpan = card.querySelector('.info-small span');
                    if (statusSpan) {
                        statusSpan.className = '';
                        if (c.priority == 2) {
                            statusSpan.className = 'status-locked';
                            statusSpan.textContent = 'Ręczna zmiana';
                        } else if (c.priority == 1) {
                            statusSpan.className = 'status-auto';
                            statusSpan.textContent = 'AutoTemp';
                        } else {
                            statusSpan.className = 'status-default';
                            statusSpan.textContent = 'System';
                        }
                    }

                    // Update detail view
                    const currTempEl = document.getElementById(`curr-temp-${c.controller_id}`);
                    if (currTempEl) {
                        currTempEl.textContent = `${c.curr_temp}°C`;
                    }

                    const targetTempEl = document.getElementById(`target-temp-${c.controller_id}`);
                    if (targetTempEl) {
                        targetTempEl.textContent = `${c.target_temp}°C`;
                    }

                    const prefTempEl = document.getElementById(`pref-temp-${c.controller_id}`);
                    if (prefTempEl) {
                        prefTempEl.textContent = `${c.user_pref_temp || '21.5'}°C`;
                    }

                    // Update checkbox
                    const checkbox = document.getElementById(`autotemp-${c.controller_id}`);
                    if (checkbox) {
                        checkbox.checked = !!c.user_pref_temp;
                    }
                });
            } catch (error) {
                console.error('Error refreshing controllers:', error);
            }
        }

        // Show first controller by default on page load
        window.addEventListener("DOMContentLoaded", function () {
            const firstCard = document.querySelector(".controller-card");
            if (firstCard) {
                const controllerId = firstCard.id.replace("card-", "");
                selectController(controllerId);
            }

            // Auto-refresh every 2 seconds
            setInterval(refreshControllers, 2000);
        });
    </script>

</body>

</html>