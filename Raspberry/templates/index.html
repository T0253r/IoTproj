<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IoT Device Manager</title>
    <style>
        body { font-family: sans-serif; margin: 40px; background: #f4f4f9; }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 40px;}
        table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; vertical-align: middle; }
        th { background-color: #007bff; color: white; }
        .status-on { color: green; font-weight: bold; }
        .status-off { color: gray; }
        .save-btn { background: #28a745; color: white; border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; }
        .manual-btn { background: #dc3545; color: white; border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; }
        input[type="text"], input[type="number"] { padding: 5px; border: 1px solid #ccc; border-radius: 3px; width: 80px; }
        .info-small { font-size: 0.85em; color: #666; display: block; margin-top: 4px;}
    </style>
</head>
<body>

    <h2>Connected Network Devices</h2>
    <table>
        <thead>
            <tr>
                <th>Status</th>
                <th>Hostname</th>
                <th>IP Address</th>
                <th>MAC Address</th>
                <th>Friendly Username</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for device in devices %}
            <tr>
                <td>
                    <span class="{{ 'status-on' if device['online'] else 'status-off' }}">
                        {{ "● Online" if device['online'] else "○ Offline" }}
                    </span>
                </td>
                <td>{{ device['hostname'] }}</td>
                <td>{{ device['ip'] }}</td>
                <td><code>{{ device['mac'] }}</code></td>
                <form action="/update_username" method="POST">
                    <td>
                        <input type="text" name="username" value="{{ device['username'] or '' }}" placeholder="Enter name..." style="width: 150px;">
                    </td>
                    <td>
                        {% if current_user and current_user['mac'] == device['mac'] %}
                            <button type="submit" class="save-btn">Update My Name</button>
                        {% endif %}
                    </td>
                </form>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Heating Controllers</h2>
    {% if not current_user %}
        <p style="color:red; font-weight:bold;">You are not recognized as an online user. You cannot make changes.</p>
    {% endif %}
    
    <table>
        <thead>
            <tr>
                <th>Controller</th>
                <th>Live Data</th>
                <th>Manual Override (Priority 2)</th>
                <th>My Preference (Priority 1)</th>
            </tr>
        </thead>
        <tbody>
            {% for c in controllers %}
            <tr>
                <td>
                    <strong>{{ c['name'] }}</strong><br>
                    <span class="info-small">ID: {{ c['controller_id'] }}</span>
                </td>
                <td>
                    Current: <strong>{{ c['curr_temp'] }}°C</strong><br>
                    Target: <strong>{{ c['target_temp'] }}°C</strong><br>
                    <span class="info-small">
                        {% if c['priority'] == 2 %}
                            Locked by: {{ c['locked_by_name'] or 'Unknown' }}
                        {% elif c['priority'] == 1 %}
                            Auto: Voting Logic
                        {% else %}
                            System Default
                        {% endif %}
                    </span>
                </td>

                <td>
                    <form action="/set_manual_temp" method="POST">
                        <input type="hidden" name="controller_id" value="{{ c['controller_id'] }}">
                        <input type="number" step="0.5" name="target_temp" value="{{ c['target_temp'] }}" {{ 'disabled' if not current_user }}>
                        <button type="submit" class="manual-btn" {{ 'disabled' if not current_user }}>Force Set</button>
                    </form>
                    <span class="info-small">Sets Priority to 2 (High)</span>
                </td>

                <td>
                    <form action="/set_preference" method="POST">
                        <input type="hidden" name="controller_id" value="{{ c['controller_id'] }}">
                        <input type="number" step="0.5" name="pref_temp" value="{{ c['user_pref_temp'] or '' }}" placeholder="--.-" {{ 'disabled' if not current_user }}>
                        <button type="submit" class="save-btn" {{ 'disabled' if not current_user }}>Save Pref</button>
                    </form>
                    <span class="info-small">Used for voting (Priority 1)</span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

</body>
</html>